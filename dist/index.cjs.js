"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const t={targetWidth:160,container:document.body,html:"",css:"",data:{}},e="content-change",n="img-click",i="error",r="Container must be a valid DOM element",s="HTML content must be a string",o="Styles must be a string",a="Data must be an object",d="Target width must be a positive number",h="Card has been destroyed and cannot perform operations",l=[];for(let t=0;t<256;++t)l.push((t+256).toString(16).slice(1));let c;const p=new Uint8Array(16);var u={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function g(t,e,n){const i=(t=t||{}).random??t.rng?.()??function(){if(!c){if("undefined"==typeof crypto||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");c=crypto.getRandomValues.bind(crypto)}return c(p)}();if(i.length<16)throw new Error("Random bytes length must be >= 16");return i[6]=15&i[6]|64,i[8]=63&i[8]|128,function(t,e=0){return(l[t[e+0]]+l[t[e+1]]+l[t[e+2]]+l[t[e+3]]+"-"+l[t[e+4]]+l[t[e+5]]+"-"+l[t[e+6]]+l[t[e+7]]+"-"+l[t[e+8]]+l[t[e+9]]+"-"+l[t[e+10]]+l[t[e+11]]+l[t[e+12]]+l[t[e+13]]+l[t[e+14]]+l[t[e+15]]).toLowerCase()}(i)}function f(){return`shadow-card-${u.randomUUID&&!t?u.randomUUID():g(t)}`;var t}const m={validateContainer(t){if(!(t instanceof HTMLElement))throw new Error(r)},validateHtml(t){if("string"!=typeof t)throw new Error(s)},validateCss(t){if("string"!=typeof t)throw new Error(o)},validateData(t){if(null!==t&&"object"!=typeof t)throw new Error(a)},validateTargetWidth(t){if("number"!=typeof t||t<=0||isNaN(t))throw new Error(d)},validateNotDestroyed(t){if(t.isDestroyed)throw new Error(h)}};class y{constructor(e={}){try{this.options={...t||{},...e||{}},this.options.container=this.options.container||document.body,this.id=f?f():`shadow-card-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,this.isDestroyed=!1,this.data={...this.options.data},this.eventListeners=new Map,this.resizeTimer=null;try{m&&"function"==typeof m.validateContainer&&m.validateContainer(this.options.container),m&&"function"==typeof m.validateHtml&&m.validateHtml(this.options.html),m&&"function"==typeof m.validateCss&&m.validateCss(this.options.css),m&&"function"==typeof m.validateData&&m.validateData(this.options.data),m&&"function"==typeof m.validateTargetWidth&&m.validateTargetWidth(this.options.targetWidth)}catch(t){throw this.dispatchError(t?.message||String(t)),t}this.element=this.createHostElement(),this.shadow=this.element.shadowRoot,this.innerContainer=this.shadow&&this.shadow.getElementById("inner-container"),this.setHTML(this.options.html||""),this.options.css&&this.setStyle(this.options.css),this.options.data&&this.setContent(this.options.data),this.options.container.appendChild(this.element),this.resizeTimer=setTimeout(()=>{this.resize().catch(()=>{})},0)}catch(t){try{this.dispatchError(t?.message||String(t))}catch(t){}throw t}}waitForImages(t={}){const e=t&&Number(t.timeoutMs)||0;return new Promise(t=>{try{const n=this.shadow?Array.from(this.shadow.querySelectorAll("img")):[];if(!n.length)return void t();let i=0;const r=n.length,s=()=>{i++,i>=r&&t()};n.forEach(t=>{if(t.complete)return void s();const e=()=>{t.removeEventListener("load",e),t.removeEventListener("error",e),s()};t.addEventListener("load",e,{once:!0}),t.addEventListener("error",e,{once:!0})}),e>0&&setTimeout(()=>{t()},e)}catch(e){t()}})}createHostElement(){const t=document.createElement("shadow-card");t.id=this.id,t.dataset.id=this.id,this.applyStyleVariables(t);const e=t.attachShadow({mode:"open"});return e.innerHTML=`\n        <style>\n        :host {\n            all: initial;\n            display: block;\n            border: var(--shadow-card-border, 2px solid var(--shadow-card-border-color));\n            border-radius: var(--shadow-card-border-radius, 6px);\n            cursor: pointer;\n            overflow: hidden;\n            box-sizing: border-box;\n            transition: border 0.3s ease;\n            user-select: none;\n            position: relative;\n            margin: ${this.options?.styles?.margin||"8px auto"};\n            width: ${this.options?.targetWidth?`${Number(this.options.targetWidth)}px`:"auto"};\n        }\n        \n        :host(:hover) {\n            border-color: var(--shadow-card-hover-border-color, #3b82f6);\n        }\n        \n        #inner-container {\n            /* width: 100%; */\n            width:640px;\n            transform-origin: top left;\n            transform: scale(1);\n            display: flex;\n            align-items: center;\n            justify-content: center;\n        }\n\n        #loading-overlay {\n            position: absolute;\n            inset: 0;\n            background: var(--shadow-card-loading-bg, #ffffff);\n            color: var(--shadow-card-loading-color, #4b5563);\n            font-size: var(--shadow-card-loading-font-size, 0.8rem);\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            gap: var(--shadow-card-loading-gap, 8px);\n            z-index: 10;\n            opacity: 1;\n            transition: opacity 0.3s ease;\n        }\n        \n        .loading-spinner {\n            width: var(--shadow-card-loading-icon-size, 20px);\n            height: var(--shadow-card-loading-icon-size, 20px);\n            border: 2px solid var(--shadow-card-loading-spinner-border, rgba(0, 0, 0, 0.1));\n            border-top-color: var(--shadow-card-loading-spinner-color, #3b82f6);\n            border-radius: 50%;\n            animation: spin var(--shadow-card-loading-spinner-speed, 1s) linear infinite;\n        }\n        \n        @keyframes spin {\n            to { transform: rotate(360deg); }\n        }\n        \n        #loading-overlay.hidden {\n            opacity: 0;\n            pointer-events: none;\n        }\n        </style>\n        <div id="loading-overlay">\n            <div class="loading-spinner" aria-hidden="true"></div>\n            <span class="loading-text">${this.options?.styles?.loadingText||"Loading..."}</span>\n        </div>\n        <div id="inner-container" role="region" aria-label="shadow-card-content"></div>\n    `,this.boundInputHandler=t=>this.handleInput(t),this.boundClickHandler=t=>this.handleClick(t),this.boundPasteHandler=t=>this.handlePaste(t),e.addEventListener("input",this.boundInputHandler),e.addEventListener("click",this.boundClickHandler),e.addEventListener("paste",this.boundPasteHandler),t}handlePaste(t){if(this.isDestroyed)return;if(!t)return;if(t.__shadowCardHandled)return;try{Object.defineProperty(t,"__shadowCardHandled",{value:!0,configurable:!0})}catch(e){t.__shadowCardHandled=!0}try{"function"==typeof t.preventDefault&&t.preventDefault(),"function"==typeof t.stopImmediatePropagation&&t.stopImmediatePropagation(),"function"==typeof t.stopPropagation&&t.stopPropagation()}catch(t){}let e=t.target;for(;e&&e.nodeType===Node.ELEMENT_NODE&&!e.isContentEditable;)e=e.parentElement;if(!e||!e.isContentEditable)return;const n=t.clipboardData||window.clipboardData;if(!n)return;const i=n.getData("text/html")||"",r=n.getData("text")||"",s=""!==i.trim()?i:r?this.escapeHtml(r).replace(/\n/g,"<br/>"):"";if(!s)return;const o="function"==typeof this.sanitizeHtmlContent?this.sanitizeHtmlContent(s):s;let a=null;try{const t=e.getRootNode&&e.getRootNode();t&&"function"==typeof t.getSelection&&(a=t.getSelection()),a||(a=window.getSelection())}catch(t){a=window.getSelection()}try{e.focus()}catch(t){}if("function"==typeof document.execCommand)try{if(a&&a.rangeCount>0){let t=a.getRangeAt(0);if(!e.contains(t.startContainer)){t=document.createRange(),t.selectNodeContents(e),t.collapse(!1);try{a.removeAllRanges(),a.addRange(t)}catch(t){}}}else if(a)try{const t=document.createRange();t.selectNodeContents(e),t.collapse(!1),a.removeAllRanges(),a.addRange(t)}catch(t){}if(document.execCommand("insertHTML",!1,o))return}catch(t){}try{let t=a&&a.rangeCount>0?a.getRangeAt(0).cloneRange():null;t&&e.contains(t.startContainer)?t.deleteContents():(t=document.createRange(),t.selectNodeContents(e),t.collapse(!1));const n=document.createElement("div");n.innerHTML=o;const i=document.createDocumentFragment();let r=null;for(;n.firstChild;)r=i.appendChild(n.firstChild);if(t.insertNode(i),r)try{const t=document.createRange();t.setStartAfter(r),t.collapse(!0),a&&(a.removeAllRanges(),a.addRange(t))}catch(t){}}catch(t){try{const t=r||"",n=document.createTextNode(t);e.appendChild(n)}catch(t){console.error("Paste fallback failed:",t)}}}escapeHtml(t=""){return String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}sanitizeHtmlContent(t=""){if(!t||"string"!=typeof t)return"";const e=new Set(["b","i","strong","em","u","s","sub","sup","span","br","p","div"]),n=new Set(["data-field","data-img"]),i=(new DOMParser).parseFromString(`<div>${t}</div>`,"text/html").body.firstChild;if(!i)return"";const r=document.createTreeWalker(i,NodeFilter.SHOW_ELEMENT|NodeFilter.SHOW_TEXT|NodeFilter.SHOW_COMMENT,null,!1),s=[],o=[];let a=r.nextNode();for(;a;)o.push(a),a=r.nextNode();return o.forEach(t=>{if(t.nodeType!==Node.COMMENT_NODE){if(t.nodeType===Node.ELEMENT_NODE){const i=t.tagName.toLowerCase();if(!e.has(i)){const e=t.parentNode;for(;t.firstChild;)e.insertBefore(t.firstChild,t);return void s.push(t)}for(let e=t.attributes.length-1;e>=0;e--){const i=t.attributes[e],r=i.name.toLowerCase();if(n.has(r)){const e=String(i.value||"");/^\s*javascript:/i.test(e)&&t.removeAttribute(i.name)}else t.removeAttribute(i.name)}}}else s.push(t)}),s.forEach(t=>t.parentNode&&t.parentNode.removeChild(t)),i.innerHTML}applyStyleVariables(t){if(t&&t instanceof HTMLElement)try{const e=this.getStyleMappings();this.options?.styles&&"object"==typeof this.options.styles&&Object.entries(e).forEach(([e,n])=>{if(void 0!==this.options.styles[e])try{t.style.setProperty(n,this.options.styles[e])}catch(t){}})}catch(t){console.error("applyStyleVariables error",t)}}getStyleMappings(){return{border:"--shadow-card-border",borderColor:"--shadow-card-border-color",borderRadius:"--shadow-card-border-radius",hoverBorderColor:"--shadow-card-hover-border-color",loadingBg:"--shadow-card-loading-bg",loadingColor:"--shadow-card-loading-color",loadingFontSize:"--shadow-card-loading-font-size",loadingGap:"--shadow-card-loading-gap",loadingIconSize:"--shadow-card-loading-icon-size",loadingSpinnerBorder:"--shadow-card-loading-spinner-border",loadingSpinnerColor:"--shadow-card-loading-spinner-color",loadingSpinnerSpeed:"--shadow-card-loading-spinner-speed",loadingText:"--shadow-card-loading-text"}}setCssVariables(t){try{if(this.isDestroyed)return this;if(!t||"object"!=typeof t)throw new Error("Style variables must be an object");const e=this.getStyleMappings();if(Object.entries(t).forEach(([t,n])=>{const i=e[t];if(i&&void 0!==n)try{this.element.style.setProperty(i,n)}catch(t){}}),t.loadingText&&this.shadow){const e=this.shadow.querySelector(".loading-text");e&&(e.textContent=t.loadingText)}return this}catch(t){return this.dispatchError(t?.message||String(t)),this}}handleInput(t){if(!this.isDestroyed)try{const n=t.target;if(!n)return;if(n.isContentEditable&&n.hasAttribute("data-field")){const t=n.getAttribute("data-field"),i=n.innerText;this.data=this.data||{},this.data[t]=i,this.dispatchEvent(e,{field:t,value:i})}}catch(t){this.dispatchError(t?.message||String(t))}}handleClick(t){if(!this.isDestroyed)try{const e=t.target;if(!e)return;"IMG"===e.tagName&&e.hasAttribute("data-img")&&this.dispatchEvent(n,{imgKey:e.getAttribute("data-img"),element:e})}catch(t){this.dispatchError(t?.message||String(t))}}dispatchEvent(t,e={}){if(!this.isDestroyed&&this.element)try{const n=new CustomEvent(t,{detail:{...e,cardId:this.id},bubbles:!0,cancelable:!0});this.element.dispatchEvent(n);const i=this.eventListeners.get(t);i&&i.size&&i.forEach(t=>{try{t(n)}catch(t){}})}catch(t){console.error("dispatchEvent error",t)}}dispatchError(t){try{this.dispatchEvent(i,{message:t})}catch(t){}}async setHTML(t=""){try{return this.isDestroyed||(m&&"function"==typeof m.validateHtml&&m.validateHtml(t),this.innerContainer&&(this.innerContainer.innerHTML=t||"",this.innerContainer.offsetHeight,await this.resize())),this}catch(t){return this.dispatchError(t?.message||String(t)),this}}setStyle(t="",e=!1){try{if(this.isDestroyed)return this;if(m&&"function"==typeof m.validateCss&&m.validateCss(t),!this.shadow)return this;let n=this.shadow.querySelector("#custom-style");if(!n){n=document.createElement("style"),n.id="custom-style";const t=this.shadow.getElementById("inner-container");this.shadow.insertBefore(n,t)}return n.textContent=e?t||"":`${n.textContent||""}\n${t||""}`,this}catch(t){return this.dispatchError(t?.message||String(t)),this}}setContent(t={}){try{return this.isDestroyed?this:(m&&"function"==typeof m.validateData&&m.validateData(t),this.data={...this.data||{},...t||{}},this.shadow?(Object.entries(t||{}).forEach(([t,e])=>{const n=this.shadow.querySelector(`[data-field="${t}"]`);n&&n.isContentEditable&&(n.innerText=null==e?"":String(e))}),this):this)}catch(t){return this.dispatchError(t?.message||String(t)),this}}async resize(t){try{if(this.isDestroyed)return this;m&&"function"==typeof m.validateNotDestroyed&&m.validateNotDestroyed(this);const e=this.shadow&&this.shadow.querySelector("#loading-overlay");e&&e.classList.remove("hidden"),void 0!==t&&m&&"function"==typeof m.validateTargetWidth&&(m.validateTargetWidth(t),this.options.targetWidth=Number(t));const n=Number(this.options.targetWidth)||160;if(!this.element||!this.innerContainer)return e&&e.classList.add("hidden"),this;this.element.style.width=`${n}px`,this.element.style.height="auto",await this.waitForImages({timeoutMs:5e3});this.innerContainer.style.transform;this.innerContainer.style.transform="scale(1)",this.innerContainer.style.transformOrigin="top left",this.innerContainer.offsetHeight;const i=this.innerContainer.getBoundingClientRect(),r=Math.max(1,i.width||1),s=Math.max(1,i.height||1),o=Math.min(1,n/r),a=Math.round(n/Math.max(o,1e-4));this.innerContainer.style.width=`${a}px`,this.innerContainer.style.overflow="hidden",this.innerContainer.style.transform=`scale(${o})`,this.innerContainer.style.transformOrigin="top left";const d=Math.max(1,Math.round(s*o));return this.element.style.height=`${d}px`,requestAnimationFrame(()=>{e?.classList.add("hidden")}),this}catch(t){try{this.shadow?.querySelector("#loading-overlay")?.classList.add("hidden")}catch(t){}return this.dispatchError(t?.message||String(t)),this}}on(t,e){if(this.isDestroyed)return this;if("function"!=typeof e)return this.dispatchError("Event handler must be a function"),this;this.eventListeners.has(t)||this.eventListeners.set(t,new Set);this.eventListeners.get(t).add(e);try{this.element.addEventListener(t,e)}catch(t){}return this}off(t,e){if(this.isDestroyed)return this;const n=this.eventListeners.get(t);if(!n)return this;if(e){n.delete(e);try{this.element.removeEventListener(t,e)}catch(t){}}else n.forEach(e=>{try{this.element.removeEventListener(t,e)}catch(t){}}),n.clear();return 0===n.size&&this.eventListeners.delete(t),this}destroy(){if(!this.isDestroyed){clearTimeout(this.resizeTimer),this.eventListeners.forEach((t,e)=>{t.forEach(t=>{try{this.element.removeEventListener(e,t)}catch(t){}})}),this.eventListeners.clear();try{this.shadow?.removeEventListener("input",this.boundInputHandler),this.shadow?.removeEventListener("click",this.boundClickHandler),this.shadow?.removeEventListener("paste",this.boundPasteHandler)}catch(t){}try{this.element?.parentNode?.removeChild(this.element)}catch(t){}this.isDestroyed=!0,this.element=null,this.shadow=null,this.innerContainer=null,this.data=null,this.options=null,this.boundInputHandler=null,this.boundClickHandler=null,this.boundPasteHandler=null}}static batchCreate(t){if(!Array.isArray(t))throw new Error("batchCreate requires an array of card configurations");return t.map(t=>new y(t))}}exports.ShadowCard=y,exports.default=y;
//# sourceMappingURL=index.cjs.js.map
